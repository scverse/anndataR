---
title: "Detailed look into the mapping from AnnData to Seurat objects"
author:
  - name: Louise Deconinck
package: anndataR
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Detailed look into the mapping from AnnData to Seurat objects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

**{anndataR}** provides a way to convert between `AnnData` and `Seurat` objects. This vignette will provide a detailed look
into the mapping between the two objects.
The conversion can be done with or without extra user input as to which fields and slots of the respective objects should be
converted into the other object.
Please take into account that lossless conversion is not always possible between AnnData and Seurat objects due to differences in the object structure.
Have a look at our known issues section for more information and please inspect the object before and after conversion to make
sure that the conversion was successful.

```{r deps}
suppressMessages({
  library(anndataR)
  library(Seurat)
})
```

We will first generate a sample dataset to work with:

```{r construct_anndata}
ad <- generate_dataset(
  n_obs = 10L,
  n_var = 20L,
  x_type = "numeric_matrix",
  layer_types = c("integer_matrix", "numeric_rsparse"),
  obs_types = c("integer", "numeric", "factor"),
  var_types = c("character", "numeric", "logical"),
  obsm_types = c("numeric_matrix", "numeric_csparse"),
  varm_types = c("numeric_matrix", "numeric_csparse"),
  obsp_types = c("numeric_matrix", "numeric_csparse"),
  varp_types = c("integer_matrix", "numeric_matrix"),
  uns_types = c("vec_integer", "vec_character", "df_integer"),
  format = "AnnData"
)

# add example PCA reduction
ad$obsm[["X_pca"]] <- matrix(1:50, 10, 5)
ad$varm[["PCs"]] <- matrix(1:100, 20, 5)

# add example UMAP reduction
ad$obsm[["X_umap"]] <- matrix(1:20, 10, 2)

# add example graph connectivities
ad$obsp[["connectivities"]] <- ad$obsp[["numeric_matrix"]]
ad$obsp[["connectivities_sparse"]] <- ad$obsp[["numeric_csparse"]]
```

# Convert AnnData objects to Seurat objects

By default, anndataR will try to guess a reasonable mapping between both objects, slot per slot.
This means that if you do not provide any mapping information, anndataR will try to convert
all slots in the AnnData object to the corresponding slots in the Seurat object.

For each mapping argument, you can provide three possible values:
- `TRUE`: all items in the slot will be copied using the default mapping
- `FALSE`: no items in the slot will be copied
- a named vector: all items listed in the named vector will be copied. The values refer to what the item is called in the AnnData object, the names to what it will be called in the Seurat object.

For each slot in the Seurat object, we will detail how anndataR guesses a reasonable mapping and how you can provide your own mappings.

## Implicit mapping

You can decide to not provide any mapping information, in which case anndataR will try to guess a reasonable mapping between the AnnData and Seurat objects.

```{r as_Seurat_implicit, error = TRUE}
seurat_obj <- ad$as_Seurat()
seurat_obj
```

Immediately, we run in the first error: one of the layers in the AnnData object is not named `counts` or `data`, so we cannot
implicitly determine which layer should be copied to the `counts` or `data` slot of the Seurat object.
We can either provide our own mapping using `x_mapping` or `layers_mapping`, or rename the layer in the AnnData object.

## Layers and `X` slot

Here we provide a mapping for the `x_mapping` argument, which will copy the `X` slot of the AnnData object to the `counts` slot of the Seurat object.

```{r as_Seurat_x_mapping}
seurat_obj <- ad$as_Seurat(
  x_mapping = c("X" = "counts")
)
Layers(seurat_obj)

```

We can also provide a mapping for the `layers_mapping` argument:
```{r as_Seurat_layers_mapping}
seurat_obj <- ad$as_Seurat(
  layers_mapping = c("counts" = "integer_matrix", "numeric_rsparse" = "numeric_rsparse")
)
Layers(seurat_obj)
```

We can also rename one of the layers in the AnnData object to `counts` or `data`.

```{r as_Seurat_implicit_rename}
names(ad$layers)[1] <- "counts"
seurat_obj <- ad$as_Seurat()
Layers(seurat_obj)
```

## Gene level and cell level metadata

By default, the `obs` and `var` slots of the AnnData object are copied to the object level and assay level metadata of the Seurat object.

```{r as_Seurat_obj_assay_metadata}
seurat_obj[[]] # object level metadata (obs slot)
seurat_obj[["RNA"]][[]] # assay level metadata (var slot)
```

You can provide your own mappings, or convert nothing as follows:
```{r as_Seurat_obs_var_mapping}
seurat_obj <- ad$as_Seurat(
    object_metadata_mapping = c(metadata1 = "integer"),
    assay_metadata_mapping = FALSE
)
seurat_obj[[]]
seurat_obj[["RNA"]][[]]
```

## Reductions

Reductions are a bit more complicated. 
By default, we will copy all reductions from the `obsm` slot in the AnnData object to the `reductions` slot in the Seurat object.
Additionally, we will assume that PCA will always be stored as `X_pca` in the `obsm` slot, with the loadings as `PCs` in the `varm` slot.
In this case, we will then also store the loadings of the PCA.

```{r as_Seurat_implicit_reduction}
Reductions(seurat_obj)
seurat_obj[["X_pca"]]
```

We can view the cell embeddings and loadings of the PCA reduction in the Seurat object as follows:

```{r as_Seurat_implicit_reduction_loadings}
seurat_obj[["X_pca"]][[]]
seurat_obj[["X_pca"]][]
```

We can specify this mapping explicitly as follows:
```{r as_Seurat_reduction_mapping}
seurat_obj <- ad$as_Seurat(
    reduction_mapping = list(
        pca = c(key = "PC_", embeddings = "X_pca", loadings = "PCs"),
        umap = c(key = "UMAP_", embeddings = "X_umap")
    )
)
seurat_obj[["pca"]][[]]
seurat_obj[["pca"]][]
```

## Graph connectivities

Both Seurat and AnnData allow for graphs, or pairwise relations between observations, to be stored.
By default, we will copy all graphs from the `obsp` slot in the AnnData object to the `graphs` slot in the Seurat object by name, 
prepended by the provided `assay_name` (default "RNA").

```{r as_Seurat_graphs}
Graphs(seurat_obj)
seurat_obj[["RNA_connectivities"]][1:10, 1:10]
```

We can specify this mapping explicitly as follows. Note that here we also prepend the name of the graph with the `assay_name` (default "RNA").
```{r as_Seurat_graphs_mapping}
seurat_obj <- ad$as_Seurat(
    graph_mapping = c("connectivities" = "connectivities")
)
Graphs(seurat_obj)
seurat_obj[["RNA_connectivities"]][1:10, 1:10]
```

## Miscellaneous data

By default, we will copy all information from the `uns` slot in the AnnData object to the `misc` slot in the Seurat object by name.

```{r as_Seurat_misc}
Misc(seurat_obj)
```

We can specify this mapping explicitly as follows:

```{r as_Seurat_misc_mapping}
seurat_obj <- ad$as_Seurat(
    misc_mapping = c("misc1" = "vec_integer", "misc2" = "vec_character")
)
Misc(seurat_obj)
```

## Complete explicit mapping

If we take all these explicit mappings together, we end up converting the AnnData object to a Seurat object as follows:
```{r as_Seurat_complete_mapping}
seurat_obj <- ad$as_Seurat(
    layers_mapping = c(counts = "counts", numeric_rsparse = "numeric_rsparse"),
    object_metadata_mapping = c(metadata1 = "integer"),
    assay_metadata_mapping = FALSE,
    reduction_mapping = list(
        pca = c(key = "PC_", embeddings = "X_pca", loadings = "PCs"),
        umap = c(key = "UMAP_", embeddings = "X_umap")
    ),
    graph_mapping = c(connectivities = "connectivities"),
    misc_mapping = c(misc1 = "vec_integer", misc2 = "vec_character")
)
seurat_obj
```