---
title: "Detailed look into the mapping between AnnData and Seurat objects"
author:
  - name: Louise Deconinck
package: anndataR
output: BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Detailed look into the mapping between AnnData and Seurat objects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


**{anndataR}** provides a way to convert between `AnnData` and `Seurat` objects. This vignette will provide a detailed look
into the mapping between the two objects.
The conversion can be done with or without extra user input as to which fields and slots of the respective objects should be
converted into the other object.
Please take into account that lossless conversion is not always possible between AnnData and Seurat objects due to differences in the object structure.
Have a look at our known issues section for more information and please inspect the object before and after conversion to make
sure that the conversion was successful.

```{r deps}
suppressMessages({
  library(anndataR)
  library(Seurat)
})
```

We will first generate a sample dataset to work with:

```{r construct_anndata}
ad <- generate_dataset(
  n_obs = 10L,
  n_var = 20L,
  x_type = "numeric_matrix",
  layer_types = c("integer_matrix", "numeric_rsparse"),
  obs_types = c("integer", "numeric", "factor"),
  var_types = c("character", "numeric", "logical"),
  obsm_types = c("numeric_matrix", "numeric_csparse"),
  varm_types = c("numeric_matrix", "numeric_csparse"),
  obsp_types = c("numeric_matrix", "numeric_csparse"),
  varp_types = c("integer_matrix", "numeric_matrix"),
  uns_types = c("vec_integer", "vec_character", "df_integer"),
  format = "AnnData"
)

# add example PCA reduction
ad$obsm[["X_pca"]] <- matrix(1:50, 10, 5)
ad$varm[["PCs"]] <- matrix(1:100, 20, 5)

# add example UMAP reduction
ad$obsm[["X_umap"]] <- matrix(1:20, 10, 2)

# add example graph connectivities
ad$obsp[["connectivities"]] <- ad$obsp[["numeric_matrix"]]
ad$obsp[["connectivities_sparse"]] <- ad$obsp[["numeric_csparse"]]
```

# Convert AnnData objects to Seurat objects

By default, anndataR will try to guess a reasonable mapping between both objects, slot per slot.
This means that if you do not provide any mapping information, anndataR will try to convert
all slots in the AnnData object to the corresponding slots in the Seurat object.

If you do not wish for a specific slot to be converted, you can pass a `FALSE` value for that mapping,
If you want more control over the conversion, you can provide your own mappings.

We will first detail how anndataR guesses a reasonable mapping. In the section after that, we will detail how you can provide
your own mappings.

## Implicit mapping

Here, we showcase what happens if you do not provide any mapping information for the conversion.
```{r as_Seurat_implicit, error = FALSE}
seurat_obj <- ad$as_Seurat()
seurat_obj
```

Immediately, we run in the first error: one of the layers in the AnnData object is not named `counts` or `data`, so we cannot
implicitly determine which layer should be copied to the `counts` or `data` slot of the Seurat object.
We can either provide our own mapping using `x_mapping` or `layers_mapping`, or rename the layer in the AnnData object.

Here we provide a mapping for the `x_mapping` argument, which will copy the `X` slot of the AnnData object to the `counts` slot of the Seurat object.

```{r as_Seurat_x_mapping}
seurat_obj <- ad$as_Seurat(
  x_mapping = c("X" = "counts")
)
seurat_obj
```

We can also rename one of the layers in the AnnData object to `counts` or `data`.

```{r as_Seurat_implicit_rename}
names(ad$layers)[1] <- "counts"
seurat_obj <- ad$as_Seurat()
seurat_obj
```

In the following subsections, we detail how each of these implicit conversions converted data.

### Assay name

An anndata object can only have one assay, while a Seurat object can have multiple assays. Seurat requires each assay to have a name.
By default, we will use the name "RNA" for the assay in the Seurat object.
This is different from AnnData, which does not require an assay name.

```{r implicit-assay-name}
DefaultAssay(seurat_obj)
```

### Layers and `X` slot

Seurat allows for multiple layers to be stored in the object. This corresponds with the `layers` slot in the AnnData object.
If no mapping is provided, all layers of the AnnData object will be copied by name. The `X` slot will also be copied by name.

There must be a layer called `counts` and/or `data` in the final Seurat object. If no AnnData layers are named `counts` or `data`, you must
provide a mapping for either `counts` or `data` in the `layers_mapping` argument or provide a mapping for the `X` slot with the `x_mapping` argument.

```{r as_Seurat_implicit_layers_x}
Layers(seurat_obj)
```

### Gene level and cell level metadata

Both Seurat and AnnData allow for cell and gene level metadata to be stored.
By default, we will copy all metadata from the `obs` slot in the AnnData object to the object level metadata in the Seurat object.

```{r as_Seurat_implicit_obs_metadata}
seurat_obj[[]]
```

By default we will copy all metadata from the `var` slot in the AnnData object to the assay level metadata in the Seurat object.

```{r as_Seurat_implicit_assay_metadata}
seurat_obj[["RNA"]][[]]
```

### Reductions

Reductions are a bit more complicated. 
By default, we will copy all reductions from the `obsm` slot in the AnnData object to the `reductions` slot in the Seurat object.
Additionally, we will assume that PCA will always be stored as `X_pca` in the `obsm` slot, with the loadings as `PCs` in the `varm` slot.
In this case, we will then also store the loadings of the PCA.

```{r as_Seurat_implicit_reduction}
Reductions(seurat_obj)
seurat_obj[["X_pca"]]
```

We can view the cell embeddings and loadings of the PCA reduction in the Seurat object as follows:

``` {r as_Seurat_implicit_reduction_loadings}
seurat_obj[["X_pca"]][[]]
seurat_obj[["X_pca"]][]
```

### Graphs

Both Seurat and AnnData allow for graphs, or pairwise relations between observations, to be stored.
By default, we will copy all graphs from the `obsp` slot in the AnnData object to the `graphs` slot in the Seurat object by name, 
prepended by the provided `assay_name` (default "RNA").

```{r as_Seurat_implicit_graph}
Graphs(seurat_obj)
seurat_obj[["RNA_connectivities"]][1:10, 1:10]
```

###  misc_mapping

By default, we will copy all information from the `uns` slot in the AnnData object to the `misc` slot in the Seurat object by name.

```{r as_Seurat_implicit_misc}
Misc(seurat_obj)
```

## Explicit mapping

Each of these implicit mappings can be overridden by providing an explicit mapping.
This allows you to have full control over what is copied from the AnnData object to the Seurat object.
Each of the mapping arguments can be provided with:
- `TRUE`: all items in the slot will be copied using the default mapping
- `FALSE`: no items in the slot will be copied
- a named vector: all items listed in the named vector will be copied. The values refer to what the item is called in the AnnData object, the names to what it will be called in the Seurat object.

```{r as_Seurat explicit_mapping}
seurat_obj <- ad$as_Seurat(
  assay_name = "Other_assay",
  x_mapping = "data",
  layers_mapping = c(counts = "counts", other_layer = "numeric_rsparse"),
  object_metadata_mapping = c(metadata1 = "integer", metadata2 = "numeric"),
  assay_metadata_mapping = c(metadata1 = "numeric", metadata2 = "logical"),
  reduction_mapping = list(
    pca = c(key = "PC_", embeddings = "X_pca", loadings = "PCs"),
    umap = c(key = "UMAP_", embeddings = "X_umap")
  ),
  graph_mapping = c(connectivities = "numeric_matrix"),
  misc_mapping = c(uns_vec = "vec_integer", uns_df = "df_integer")
)
seurat_obj
```

We can also decide not to convert some of the slots, by passing `FALSE` to the mapping argument, or to use the default mapping by passing `TRUE`.

```{r as_Seurat explicit_mapping2}
seurat_obj <- ad$as_Seurat(
  assay_name = "Other_assay",
  x_mapping = "data",
  layers_mapping = c(counts = "counts", other_layer = "numeric_rsparse"),
  object_metadata_mapping = TRUE,
  assay_metadata_mapping = c(metadata1 = "numeric", metadata2 = "logical"),
  reduction_mapping = FALSE,
  graph_mapping = c(connectivities = "numeric_matrix"),
  misc_mapping = c(uns_vec = "vec_integer", uns_df = "df_integer")
)
seurat_obj[[]]
Reductions(seurat_obj)
```

# Convert Seurat objects to AnnData objects

By default, anndataR will try to guess a reasonable mapping between both objects, slot per slot.
This means that if you do not provide any mapping information, anndataR will try to convert
all slots in the Seurat object to the corresponding slots in the AnnData object.

If you do not wish for a specific slot to be converted, you can pass a `FALSE` value for that mapping,
If you want more control over the conversion, you can provide your own mappings.

We will first detail how anndataR guesses a reasonable mapping. In the section after that, we will detail how you can provide
your own mappings.

## Implicit mapping

We first create an example Seurat object to work with.

```{r create_Seurat}
suppressWarnings({
  counts <- matrix(rbinom(600, 20000, .001), nrow = 20)
  obj <- CreateSeuratObject(counts = counts) |>
    NormalizeData() |>
    FindVariableFeatures() |>
    ScaleData() |>
    RunPCA(npcs = 10L) |>
    FindNeighbors() |>
    RunUMAP(dims = 1:10)
  obj@misc[["data"]] <- "some data"
})
```

Here, we do not provide any mapping information, so anndataR will try to guess a reasonable mapping between the Seurat and AnnData objects.

```{r as_AnnData_implicit}
ad <- as_AnnData(obj)
ad
```

### Assay Name
The `assay_name` argument determines which assay in the Seurat object will be converted to the AnnData object.
By default it's the `DefaultAssay`.

```{r fsi_assay_name}
ad <- as_AnnData(
  obj,
  assay_name = NULL,
  layers_mapping = FALSE,
  obs_mapping = FALSE,
  var_mapping = FALSE,
  obsm_mapping = FALSE,
  varm_mapping = FALSE,
  obsp_mapping = FALSE,
  varp_mapping = FALSE,
  uns_mapping = FALSE
)
ad
```

### x_mapping
By default, no data will be put into the `X` slot of the AnnData object. If you want to put the data from a Seurat layer, such as
`counts` or `data` into the `X` slot, you need to provide a mapping.

```{r fsi_x_mapping}
ad <- as_AnnData(
  obj,
  assay_name = "RNA",
  layers_mapping = FALSE,
  obs_mapping = FALSE,
  var_mapping = FALSE,
  obsm_mapping = FALSE,
  varm_mapping = FALSE,
  obsp_mapping = FALSE,
  varp_mapping = FALSE,
  uns_mapping = FALSE
)
ad$X
```

As you can see, by default, no information was copied to the `X` slot of the AnnData object.

### layers_mapping
By default, all layers in the Seurat object will be copied to the AnnData object. This means that the `X` slot will be `NULL` (empty).

```{r fsi_layers_mapping}
ad <- as_AnnData(
  obj,
  obs_mapping = FALSE,
  var_mapping = FALSE,
  obsm_mapping = FALSE,
  varm_mapping = FALSE,
  obsp_mapping = FALSE,
  varp_mapping = FALSE,
  uns_mapping = FALSE
)

names(ad$layers)
```


### obs_mapping
The obs slot is used to store observation-level annotations, such as cell-level metadata.
By default, all information in the `meta.data` slot of the Seurat object is copied to the `obs` slot of the AnnData object.

```{r fsi_obs_mapping}
ad <- as_AnnData(
  obj,
  layers_mapping = FALSE,
  var_mapping = FALSE,
  obsm_mapping = FALSE,
  varm_mapping = FALSE,
  obsp_mapping = FALSE,
  varp_mapping = FALSE,
  uns_mapping = FALSE
)
names(ad$obs)
```

### var_mapping
The var slot is used to store feature-level annotations, such as gene-level metadata.
By default, all information in the `meta.data` slot of the specified assay of the Seurat object is copied to the `var` slot of the AnnData object.

```{r fsi_var_mapping}
ad <- as_AnnData(
  obj,
  layers_mapping = FALSE,
  obs_mapping = FALSE,
  obsm_mapping = FALSE,
  varm_mapping = FALSE,
  obsp_mapping = FALSE,
  varp_mapping = FALSE,
  uns_mapping = FALSE
)
names(ad$var)
```

### obsm_mapping
The obsm slot is used to store multidimensional observation-level annotations, such as dimensionality reductions.
By default, it will prefix the name of all Seurat reductions with `X_`.

```{r fsi_obsm_mapping}
ad <- as_AnnData(
  obj,
  layers_mapping = FALSE,
  obs_mapping = FALSE,
  var_mapping = FALSE,
  varm_mapping = FALSE,
  obsp_mapping = FALSE,
  varp_mapping = FALSE,
  uns_mapping = FALSE
)

ad
```

### varm_mapping
The varm slot is used to store multidimensional feature-level annotations. This is mainly used to store the loadings of
dimensionality reductions.
By default, all loadings of dimensionality reductions will be copied to the `varm` slot of the AnnData object.

```{r fsi_varm_mapping}
ad <- as_AnnData(
  obj,
  layers_mapping = FALSE,
  obs_mapping = FALSE,
  var_mapping = FALSE,
  obsm_mapping = FALSE,
  obsp_mapping = FALSE,
  varp_mapping = FALSE,
  uns_mapping = FALSE
)

ad$varm
```

### obsp_mapping
The obsp slot is used to store pairwise relations between observations. This is mainly used to store the connectivities of a graph.
By default, all Seurat graphs are copied to the `obsp` slot of the AnnData object.

```{r fsi_obsp_mapping}
ad <- as_AnnData(
  obj,
  layers_mapping = FALSE,
  obs_mapping = FALSE,
  var_mapping = FALSE,
  obsm_mapping = FALSE,
  varm_mapping = FALSE,
  varp_mapping = FALSE,
  uns_mapping = FALSE
)
ad$obsp
```

### varp_mapping
The varp slot is used to store pairwise relations between features.
By default, no information is copied to the `varp` slot of the AnnData object.

```{r fsi_varp_mapping}
ad <- as_AnnData(
  obj,
  layers_mapping = FALSE,
  obs_mapping = FALSE,
  var_mapping = FALSE,
  obsm_mapping = FALSE,
  varm_mapping = FALSE,
  obsp_mapping = FALSE,
  uns_mapping = FALSE
)
ad$varp
```

### uns_mapping
The uns slot is used for any non-structured miscellaneous data.
By default all information in the `misc` slot of the Seurat object is copied to the `uns` slot of the AnnData object.

```{r fsi_uns_mapping}
ad <- as_AnnData(
  obj,
  layers_mapping = FALSE,
  obs_mapping = FALSE,
  var_mapping = FALSE,
  obsm_mapping = FALSE,
  varm_mapping = FALSE,
  obsp_mapping = FALSE,
  varp_mapping = FALSE
)
ad$uns
```

## Explicit mapping

It's also possible to provide an explicit mapping for the conversion from Seurat to AnnData objects.
For all of the mappings (`layers_mapping`, `obs_mapping`, `var_mapping`, `obsm_mapping`, `varm_mapping`, `obsp_mapping`, `varp_mapping`, and `uns_mapping`),
you can provide a named vector where the names are the names in the AnnData object and the values are the names in the Seurat object.

```{r fse_explicit}
ad <- as_AnnData(
  obj,
  x_mapping = "counts",
  layers_mapping = c(data = "data"),
  obs_mapping = c(metadata1 = "orig.ident", metadata2 = "nCount_RNA"),
  var_mapping = c(metadata_mean = "vf_vst_counts_mean", metadata_variance = "vf_vst_counts_variance"),
  obsm_mapping = c(X_pca = "pca", X_umap = "umap"),
  varm_mapping = c(PCs = "pca"),
  obsp_mapping = c(connectivities = "RNA_nn"),
  uns_mapping = c(extra_data = "data")
)
ad
```

## Session info

```{r}
sessionInfo()
```
